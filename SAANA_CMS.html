<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Teacher Management & Attendance Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --primary:#4f46e5; --accent:#0ea5e9; --danger:#ef4444; --muted:#6b7280;
    --card:#ffffff; --bg:#f4f6fa;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,ui-sans-serif,system-ui,Arial; margin:0; background:var(--bg); color:#111}
  header{background:linear-gradient(90deg,var(--primary),#d5d5dd); color:white; padding:18px 20px; display:flex;align-items:center;justify-content:space-between;gap:12px}
  header h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:18px}
  .grid{display:grid;gap:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=text], input[type=password], input[type=date], select{padding:8px 10px;border:1px solid #e6e6f0;border-radius:8px;min-width:160px}
  button{background:var(--primary);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(79,70,229,0.12)}
  button.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px 10px;border-bottom:1px solid #f0f0f3;text-align:left}
  th{font-size:13px;color:var(--muted)}
  .right{text-align:right}
  .small{font-size:13px;color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:#f3f4ff;color:var(--primary);display:inline-block;font-weight:600}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:999;display:none}
  .modal .box{width:520px;max-width:92%;background:white;padding:18px;border-radius:12px}
  .flex{display:flex;gap:10px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .hidden{display:none}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
  @media (min-width:900px){
    .two{grid-template-columns:1fr 480px}
    .three{grid-template-columns:1fr 1fr 1fr}
  }
  .topbar-actions{display:flex;gap:10px;align-items:center}
  .linklike{background:none;border:none;color:var(--primary);cursor:pointer;text-decoration:underline;padding:0}
</style>
</head>
<body>

<header>
  <h1>üìö Teacher Dashboard</h1>
  <div id="headerRight" class="topbar-actions">
    <!-- populated dynamically -->
  </div>
</header>

<div class="container">

  <!-- LOGIN PAGE -->
  <div id="loginCard" class="card">
    <h2>Login</h2>
    <p class="small">Use <b>admin/admin123</b> to access admin panel. Teachers accounts can be created by admin.</p>
    <div class="grid" style="margin-top:8px">
      <div class="col" style="max-width:420px">
        <label>Username <input id="loginUser" type="text" placeholder="username"></label>
        <label>Password <input id="loginPass" type="password" placeholder="password"></label>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button id="btnLogin">Login</button>
          <button id="btnDemo" class="ghost">Quick Demo Data</button>
        </div>
        <p class="small" style="margin-top:6px">Demo will add sample teachers, students, and allocations (only if not present).</p>
      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="hidden">

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2>Admin Dashboard</h2>
          <div class="small">Manage Students, Teachers, Subject Allocation & Reports</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="loggedAs" class="small"></div>
          <button id="logoutBtn" class="ghost">Logout</button>
        </div>
      </div>
    </div>

    <div class="grid two">
      <!-- Left: Students & Teachers -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Students</h3>
            <div>
              <button id="btnAddStudent" class="">+ Add Student</button>
              <button id="btnImportExcel" class="ghost">Import Excel</button>
              <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" class="hidden">
            </div>
          </div>

          <div style="margin-top:8px" class="toolbar">
            <select id="adminFilterBranch"><option value="">All Branches</option><option>CSE</option><option>IT</option><option>ECE</option><option>ME</option><option>CE</option><option>EE</option></select>
            <select id="adminFilterSem"><option value="">All Sem</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option></select>
            <input id="adminSearch" type="text" placeholder="Search name or roll">
            <button id="btnDelAll" class="danger">Delete All</button>
          </div>

          <table id="studentsTable">
            <thead><tr><th>Name</th><th>Roll</th><th>Sem</th><th>Branch</th><th class="right">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Teachers / Users</h3>
            <div>
              <button id="btnAddTeacher">+ Add Teacher</button>
            </div>
          </div>
          <table id="teachersTable">
            <thead><tr><th>Username</th><th>Name</th><th class="small">Role</th><th class="right">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Right: Subject Allocation & Attendance Reports -->
      <div>
        <div class="card">
          <h3>Subject Allocation</h3>
          <form id="allocForm" class="col" style="margin-top:8px">
            <label>Teacher (username) <input id="allocTeacher" placeholder="teacher username"></label>
            <label>Subject <input id="allocSubject" placeholder="e.g. C++"></label>
            <div style="display:flex;gap:8px">
              <select id="allocSem"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option></select>
              <select id="allocBranch"><option>CSE</option><option>IT</option><option>ECE</option><option>ME</option><option>CE</option><option>EE</option></select>
              <button id="btnAlloc">Assign</button>
            </div>
          </form>

          <table id="allocTable">
            <thead><tr><th>Teacher</th><th>Subject</th><th>Sem</th><th>Branch</th><th class="right">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Attendance Reports (Admin)</h3>
          <div class="toolbar" style="margin-top:6px">
            <select id="repBranch"><option value="">All Branch</option><option>CSE</option><option>IT</option><option>ECE</option><option>ME</option><option>CE</option><option>EE</option></select>
            <input type="date" id="repFrom">
            <input type="date" id="repTo">
            <select id="repTeacher"><option value="">Any Teacher</option></select>
            <button id="btnShowReport">Show</button>
            <button id="btnExportAll" class="ghost">Export CSV</button>
          </div>

          <table id="reportTable">
            <thead><tr><th>Date</th><th>Teacher</th><th>Subject</th><th>Student</th><th>Roll</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- TEACHER DASHBOARD -->
  <div id="teacherDashboard" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2>Teacher Dashboard</h2>
          <div id="teacherInfo" class="small"></div>
        </div>
        <div>
          <button id="teacherLogout" class="ghost">Logout</button>
        </div>
      </div>
    </div>

    <div class="grid two">
      <div>
        <div class="card">
          <h3>My Allocated Subjects</h3>
          <div id="myAllocList" class="small" style="display:flex;flex-direction:column;gap:6px;margin-top:8px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Take Attendance</h3>
          <div class="toolbar" style="margin-top:8px">
            <select id="teacherSubjectSelect"></select>
            <input type="date" id="attDate" />
            <button id="btnLoadStudents">Load Students</button>
          </div>

          <div id="studentsForAtt" style="margin-top:10px"></div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>My Attendance Records</h3>
          <div class="toolbar" style="margin-top:8px">
            <input type="date" id="tRepFrom">
            <input type="date" id="tRepTo">
            <button id="btnShowMy">Show</button>
            <button id="btnExportMy" class="ghost">Export CSV</button>
          </div>
          <table id="myReportTable">
            <thead><tr><th>Date</th><th>Subject</th><th>Student</th><th>Roll</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- MODALS -->
<div id="modal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center"><h3 id="modalTitle">Modal</h3><button id="modalClose" class="linklike">Close</button></div>
  <div id="modalBody" style="margin-top:12px"></div>
</div></div>

<footer>Built with ‚ù§Ô∏è ‚Äî LocalStorage demo. No backend required.</footer>

<!-- XLSX library for import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
/* ---------------------------
  Data models in localStorage:
  users: [{username,password,role,name}]
  students: [{id,name,roll,semester,branch}]
  subjects: [{teacher,subject,semester,branch}]
  attendance: [{teacher,subject,studentId,status,dateISO}]
----------------------------*/

(function(){ // IIFE to avoid globals

// Utilities
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const uid = ()=> Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const nowISO = d => (d||new Date()).toISOString();
const toDateOnly = iso => new Date(iso).toLocaleString();

// LocalStorage helpers
function get(key){ try{return JSON.parse(localStorage.getItem(key) || '[]');}catch(e){return []} }
function set(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

// Seed default admin if not present
function ensureDefaults(){
  let users = get('users');
  if(!users.find(u=>u.username==='admin')){
    users.push({username:'admin',password:'admin123',role:'admin',name:'Administrator'});
    set('users',users);
  }
  if(!localStorage.getItem('students')) set('students', []);
  if(!localStorage.getItem('subjects')) set('subjects', []);
  if(!localStorage.getItem('attendance')) set('attendance', []);
}
ensureDefaults();

// Session
function setSession(user){ sessionStorage.setItem('currentUser', JSON.stringify(user)); }
function clearSession(){ sessionStorage.removeItem('currentUser'); }
function getSession(){ try{return JSON.parse(sessionStorage.getItem('currentUser')||'null');}catch(e){return null} }

// UI elements
const loginCard = $('#loginCard');
const adminDash = $('#adminDashboard');
const teacherDash = $('#teacherDashboard');
const headerRight = $('#headerRight');
const loggedAs = $('#loggedAs');

// LOGIN
$('#btnLogin').addEventListener('click', ()=>{
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value;
  if(!u||!p) return alert("Enter credentials");
  const users = get('users');
  const user = users.find(x=>x.username===u && x.password===p);
  if(!user) return alert("Invalid username/password");
  setSession(user);
  renderByRole();
});

// Quick demo data
$('#btnDemo').addEventListener('click', ()=>{
  // only add if empty to avoid duplicates
  const users = get('users');
  if(!users.find(u=>u.username==='ram')){
    users.push({username:'ram',password:'ram123',role:'teacher',name:'Ram Kumar'});
    set('users', users);
  }
  const students = get('students');
  if(students.length<6){
    const sample = [
      {id:uid(),name:'Aman Sharma',roll:'CSE101',semester:'1',branch:'CSE'},
      {id:uid(),name:'Sunita Verma',roll:'CSE102',semester:'1',branch:'CSE'},
      {id:uid(),name:'Ravi Singh',roll:'CSE103',semester:'2',branch:'CSE'},
      {id:uid(),name:'Maya Devi',roll:'IT201',semester:'2',branch:'IT'},
      {id:uid(),name:'Karan Patel',roll:'ECE101',semester:'1',branch:'ECE'}
    ];
    set('students', students.concat(sample));
  }
  const subjects = get('subjects');
  if(!subjects.find(s=>s.teacher==='ram' && s.subject==='C++')){
    subjects.push({teacher:'ram',subject:'C++',semester:'1',branch:'CSE'});
    subjects.push({teacher:'ram',subject:'Python',semester:'2',branch:'CSE'});
    set('subjects', subjects);
  }
  alert("Demo data added. Login as admin or ram/ram123 to try.");
});

// Render UI based on role
function renderByRole(){
  const cur = getSession();
  if(!cur){ loginCard.classList.remove('hidden'); adminDash.classList.add('hidden'); teacherDash.classList.add('hidden'); headerRight.innerHTML=''; return; }
  loginCard.classList.add('hidden');
  if(cur.role==='admin'){ adminDash.classList.remove('hidden'); teacherDash.classList.add('hidden'); renderAdmin(); }
  else { teacherDash.classList.remove('hidden'); adminDash.classList.add('hidden'); renderTeacher(); }
  headerRight.innerHTML = `<div class="small">Hi, <b>${cur.name||cur.username}</b> (${cur.role})</div>`;
  loggedAs.textContent = `Logged as ${cur.username}`;
}

// LOGOUT
$('#logoutBtn').addEventListener('click', ()=>{ clearSession(); renderByRole(); });
$('#teacherLogout').addEventListener('click', ()=>{ clearSession(); renderByRole(); });

// ADMIN FUNCTIONS

function renderAdmin(){
  populateTeachersTable();
  populateStudentsTable();
  populateAllocTable();
  populateReportTeacherSelect();
  attachAdminEvents();
  $('#adminSearch').value='';
}

function attachAdminEvents(){
  $('#btnAddStudent').onclick = ()=> openModal('Add Student', studentFormHtml(), (form)=> {
    const data = {
      id: uid(),
      name: form.querySelector('#s_name').value.trim(),
      roll: form.querySelector('#s_roll').value.trim(),
      semester: form.querySelector('#s_sem').value,
      branch: form.querySelector('#s_branch').value
    };
    if(!data.name||!data.roll) return alert('Provide name and roll');
    const students = get('students'); students.push(data); set('students', students);
    closeModal(); populateStudentsTable();
  });

  $('#btnAddTeacher').onclick = ()=> openModal('Add Teacher', teacherFormHtml(), (form)=> {
    const username = form.querySelector('#t_username').value.trim();
    const pass = form.querySelector('#t_pass').value || 'teach123';
    const name = form.querySelector('#t_name').value.trim() || username;
    if(!username) return alert('Provide username');
    const users = get('users');
    if(users.find(u=>u.username===username)) return alert('Username exists');
    users.push({username, password:pass, role:'teacher', name});
    set('users', users);
    closeModal(); populateTeachersTable(); populateReportTeacherSelect();
  });

  $('#btnAlloc').onclick = (e)=>{ e.preventDefault();
    const teacher = $('#allocTeacher').value.trim();
    const subject = $('#allocSubject').value.trim();
    const sem = $('#allocSem').value;
    const branch = $('#allocBranch').value;
    if(!teacher||!subject) return alert('Fill teacher and subject');
    const users = get('users'); if(!users.find(u=>u.username===teacher && u.role==='teacher')) return alert('Teacher username not found');
    const subjects = get('subjects');
    subjects.push({teacher,subject,semester:sem,branch});
    set('subjects', subjects); $('#allocTeacher').value=''; $('#allocSubject').value=''; populateAllocTable(); populateReportTeacherSelect();
  };

  $('#btnDelAll').onclick = ()=>{ if(!confirm('Delete ALL students?')) return; set('students', []); populateStudentsTable(); };

  // Import Excel
  $('#btnImportExcel').onclick = ()=> $('#excelFile').click();
  $('#excelFile').addEventListener('change', (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (e)=>{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
      rows.slice(1).forEach(r=>{
        if(r.length>=4){
          const students = get('students');
          students.push({id:uid(), name:r[0], roll:r[1], semester:String(r[2]), branch:r[3]});
          set('students', students);
        }
      });
      populateStudentsTable();
      alert('Imported');
    };
    reader.readAsArrayBuffer(f);
  });

  // Search & filters
  $('#adminSearch').addEventListener('input', populateStudentsTable);
  $('#adminFilterBranch').addEventListener('change', populateStudentsTable);
  $('#adminFilterSem').addEventListener('change', populateStudentsTable);

  // Reports
  $('#btnShowReport').onclick = showAdminReport;
  $('#btnExportAll').onclick = exportAdminReportCSV;
}

function studentFormHtml(data){
  data = data || {};
  return `<div class="col">
    <label>Name <input id="s_name" type="text" value="${data.name||''}"></label>
    <label>Roll <input id="s_roll" type="text" value="${data.roll||''}"></label>
    <div style="display:flex;gap:8px">
      <select id="s_sem">${[1,2,3,4,5,6,7,8].map(s=>`<option ${String(s)===String(data.semester)?'selected':''}>${s}</option>`).join('')}</select>
      <select id="s_branch"><option ${data.branch==='CSE'?'selected':''}>CSE</option><option ${data.branch==='IT'?'selected':''}>IT</option><option ${data.branch==='ECE'?'selected':''}>ECE</option><option ${data.branch==='ME'?'selected':''}>ME</option><option ${data.branch==='CE'?'selected':''}>CE</option><option ${data.branch==='EE'?'selected':''}>EE</option></select>
    </div>
  </div>`;
}

function teacherFormHtml(){
  return `<div class="col">
    <label>Username <input id="t_username" type="text"></label>
    <label>Name <input id="t_name" type="text"></label>
    <label>Password <input id="t_pass" type="text" placeholder="default: teach123"></label>
  </div>`;
}

function openModal(title, bodyHtml, onSubmit){
  $('#modalTitle').textContent = title;
  $('#modalBody').innerHTML = bodyHtml + `<div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="modalCancel" class="ghost">Cancel</button><button id="modalOk" style="margin-left:8px">Save</button></div>`;
  $('#modal').style.display='flex';
  $('#modalClose').onclick = closeModal;
  $('#modalCancel').onclick = closeModal;
  $('#modalOk').onclick = ()=>{ if(onSubmit) onSubmit($('#modalBody')); };
}
function closeModal(){ $('#modal').style.display='none'; $('#modalBody').innerHTML=''; }

// populate tables
function populateStudentsTable(){
  const tbody = $('#studentsTable tbody'); tbody.innerHTML='';
  const students = get('students');
  const q = $('#adminSearch').value.trim().toLowerCase();
  const fb = $('#adminFilterBranch').value;
  const fs = $('#adminFilterSem').value;
  students.filter(s=>{
    if(q && !(s.name.toLowerCase().includes(q) || s.roll.toLowerCase().includes(q))) return false;
    if(fb && s.branch!==fb) return false;
    if(fs && s.semester!==fs) return false;
    return true;
  }).forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.roll}</td><td>${s.semester}</td><td>${s.branch}</td>
      <td class="right">
        <button class="ghost" data-id="${s.id}" onclick="editStudent('${s.id}')">Edit</button>
        <button class="ghost" onclick="deleteStudent('${s.id}')">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // expose edit handlers in global for inline onclick (small hack)
  window.editStudent = (id)=>{
    const students = get('students'); const s = students.find(x=>x.id===id); if(!s) return;
    openModal('Edit Student', studentFormHtml(s), (form)=>{
      s.name = form.querySelector('#s_name').value; s.roll = form.querySelector('#s_roll').value;
      s.semester = form.querySelector('#s_sem').value; s.branch = form.querySelector('#s_branch').value;
      set('students', students); closeModal(); populateStudentsTable();
    });
  };
  window.deleteStudent = (id)=>{
    if(!confirm('Delete student?')) return;
    let students = get('students'); students = students.filter(s=>s.id!==id); set('students', students); populateStudentsTable();
  };
}

function populateTeachersTable(){
  const tbody = $('#teachersTable tbody'); tbody.innerHTML='';
  const users = get('users').filter(u=>u.role==='teacher');
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.username}</td><td>${u.name||''}</td><td class="small">${u.role}</td>
      <td class="right">
        <button class="ghost" onclick="editTeacher('${u.username}')">Edit</button>
        <button class="ghost" onclick="delTeacher('${u.username}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  window.editTeacher = (username)=>{
    const users = get('users'); const u = users.find(x=>x.username===username); if(!u) return;
    openModal('Edit Teacher', `<div class="col"><label>Name <input id="e_name" value="${u.name||''}"></label><label>Password <input id="e_pass" placeholder="leave blank to keep"></label></div>`, (form)=>{
      u.name = form.querySelector('#e_name').value || u.name;
      const p = form.querySelector('#e_pass').value; if(p) u.password = p;
      set('users', users); closeModal(); populateTeachersTable(); populateReportTeacherSelect();
    });
  };
  window.delTeacher = (username)=>{
    if(!confirm('Delete teacher and related subject allocations?')) return;
    let users = get('users'); users = users.filter(u=>u.username!==username); set('users', users);
    let subjects = get('subjects'); subjects = subjects.filter(s=>s.teacher!==username); set('subjects', subjects);
    populateTeachersTable(); populateAllocTable(); populateReportTeacherSelect();
  };
}

function populateAllocTable(){
  const tbody = $('#allocTable tbody'); tbody.innerHTML='';
  const subs = get('subjects');
  subs.forEach((a, i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.teacher}</td><td>${a.subject}</td><td>${a.semester}</td><td>${a.branch}</td>
      <td class="right"><button class="ghost" onclick="delAlloc(${i})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  window.delAlloc = (i)=>{ if(!confirm('Remove allocation?')) return; const subs = get('subjects'); subs.splice(i,1); set('subjects', subs); populateAllocTable(); };
}

function populateReportTeacherSelect(){
  const sel = $('#repTeacher'); sel.innerHTML = `<option value="">Any Teacher</option>`;
  get('users').filter(u=>u.role==='teacher').forEach(t=> sel.innerHTML += `<option value="${t.username}">${t.username} (${t.name||''})</option>`);
}

// ADMIN REPORTS
function showAdminReport(){
  const from = $('#repFrom').value ? new Date($('#repFrom').value) : null;
  const to = $('#repTo').value ? new Date($('#repTo').value) : null;
  if(to) to.setHours(23,59,59,999);
  const branch = $('#repBranch').value;
  const teacher = $('#repTeacher').value;
  const att = get('attendance');
  const students = get('students');
  let filtered = att.filter(a=>{
    const d = new Date(a.date);
    if(from && d < from) return false;
    if(to && d > to) return false;
    if(branch && a.branch !== branch) return false;
    if(teacher && a.teacher !== teacher) return false;
    return true;
  });
  const tbody = $('#reportTable tbody'); tbody.innerHTML = '';
  filtered.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(r=>{
    const s = students.find(x=>x.id===r.studentId) || {};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(r.date).toLocaleString()}</td><td>${r.teacher}</td><td>${r.subject}</td><td>${s.name||'Deleted'}</td><td>${s.roll||'-'}</td><td>${r.status}</td>`;
    tbody.appendChild(tr);
  });
}

function exportAdminReportCSV(){
  const rows = [['Date','Teacher','Subject','Student','Roll','Sem','Branch','Status']];
  const tbody = $('#reportTable tbody');
  if(tbody.children.length===0){ alert('No records to export.'); return; }
  [...tbody.children].forEach(tr=>{
    const tds = [...tr.children].map(td=>td.textContent.replace(/,/g,''));
    rows.push(tds);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'attendance_report.csv'; a.click();
}

/* ---------------- TEACHER DASHBOARD ---------------- */
function renderTeacher(){
  const cur = getSession();
  $('#teacherInfo').textContent = `${cur.username} ‚Äî ${cur.name||''}`;
  populateMyAllocations();
  $('#attDate').value = (new Date()).toISOString().slice(0,10);
  $('#btnLoadStudents').onclick = loadStudentsForAttendance;
  $('#btnShowMy').onclick = showMyRecords;
  $('#btnExportMy').onclick = exportMyCSV;
}

function populateMyAllocations(){
  const cur = getSession();
  const my = get('subjects').filter(s=>s.teacher===cur.username);
  const list = $('#myAllocList'); list.innerHTML='';
  const sel = $('#teacherSubjectSelect'); sel.innerHTML='';
  my.forEach((m,i)=>{
    const d = document.createElement('div');
    d.innerHTML = `<div class="pill">${m.subject} ‚Äî ${m.branch} Sem ${m.semester}</div>`;
    list.appendChild(d);
    sel.innerHTML += `<option value="${i}">${m.subject} ‚Äî ${m.branch} (Sem ${m.semester})</option>`;
  });
  if(my.length===0){ list.innerHTML = '<div class="small">No allocations. Ask admin to assign subjects to you.</div>'; sel.innerHTML = '<option value="">--No subject--</option>'; }
}

function loadStudentsForAttendance(){
  const idx = $('#teacherSubjectSelect').value;
  const subs = get('subjects');
  if(!idx && idx!=='0') return alert('Select subject');
  const alloc = subs[idx];
  if(!alloc) return alert('Invalid allocation');
  const students = get('students').filter(s=> s.branch===alloc.branch && String(s.semester)===String(alloc.semester));
  const container = $('#studentsForAtt'); container.innerHTML='';
  if(students.length===0) { container.innerHTML='<div class="small">No students found for this branch/semester.</div>'; return; }
  const dateVal = $('#attDate').value || (new Date()).toISOString().slice(0,10);
  const dateISO = new Date(dateVal).toISOString();
  const tb = document.createElement('table'); tb.innerHTML = `<thead><tr><th>Student</th><th>Roll</th><th class="right">Mark</th></tr></thead>`;
  const tbody = document.createElement('tbody');
  students.forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${s.name}</td><td>${s.roll}</td>
      <td class="right">
        <button onclick="markAtt('${s.id}','Present',${idx})">P</button>
        <button onclick="markAtt('${s.id}','Absent',${idx})">A</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tb.appendChild(tbody);
  container.appendChild(tb);
  // expose global markAtt
  window.markAtt = function(studentId, status, allocIndex){
    const cur = getSession();
    const subs = get('subjects');
    const alloc = subs[allocIndex];
    if(!alloc) return alert('Allocation missing');
    const dateVal = $('#attDate').value || (new Date()).toISOString().slice(0,10);
    const dateISO = new Date(dateVal).toISOString();
    const attendance = get('attendance');
    attendance.push({
      teacher: cur.username,
      subject: alloc.subject,
      studentId,
      status,
      date: dateISO,
      semester: alloc.semester,
      branch: alloc.branch
    });
    set('attendance', attendance);
    alert('Marked '+status);
  };
}

function showMyRecords(){
  const cur = getSession();
  const from = $('#tRepFrom').value ? new Date($('#tRepFrom').value) : null;
  const to = $('#tRepTo').value ? new Date($('#tRepTo').value) : null; if(to) to.setHours(23,59,59,999);
  const att = get('attendance').filter(a=> a.teacher===cur.username ).filter(a=>{
    const d = new Date(a.date);
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  });
  const tbody = $('#myReportTable tbody'); tbody.innerHTML='';
  const students = get('students');
  att.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(r=>{
    const s = students.find(x=>x.id===r.studentId) || {};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(r.date).toLocaleString()}</td><td>${r.subject}</td><td>${s.name||'Deleted'}</td><td>${s.roll||'-'}</td><td>${r.status}</td>`;
    tbody.appendChild(tr);
  });
}

function exportMyCSV(){
  const tbody = $('#myReportTable tbody'); if(tbody.children.length===0) return alert('No records');
  const rows = [['Date','Subject','Student','Roll','Status']];
  [...tbody.children].forEach(tr=> rows.push([...tr.children].map(td=>td.textContent.replace(/,/g,''))));
  const csv = rows.map(r=>r.join(',')).join('\n'); const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'my_attendance.csv'; a.click();
}

/* ----------------- Initialization ----------------- */

// initialize UI state
renderByRole();

// some functions used in global onclick contexts need to be defined on window earlier
window.openModal = openModal;
window.closeModal = closeModal;

})(); // IIFE end
</script>
</body>
</html>
